const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lib-DwfjP82C.js","assets/rolldown-runtime-B6ubh40S.js","assets/core-BdPZXYRH.js","assets/core-DHkeLF_t.js"])))=>i.map(i=>d[i]);
import{s as e}from"./rolldown-runtime-B6ubh40S.js";import{a as t,i as n,n as r,t as i}from"../vendor/1-CH-8zZtd.js";import{An as a,Ln as o,On as s,_n as c,bn as l,f as u,m as d,p as f}from"./index-C8r3tZ1D.js";import{n as p}from"./core-DHkeLF_t.js";import{n as m,t as h}from"../vendor/0-UgL7uuFy.js";var g=(e,t,n)=>(t.has(n)?t:t.set(n,e())).get(n),ee=new WeakMap,te=(e,t,n,r)=>g(e,g(()=>new WeakMap,g(()=>new WeakMap,ee,t),n),r);function _(e,t,n=Object.is){return te(()=>{let r=Symbol(),i=([e,i])=>{if(i===r)return t(e);let a=t(e,i);return n(i,a)?i:a},o=a(t=>{let n=t(o);return i([t(e),n])});return o.init=r,o},e,t,n)}var ne=e=>typeof e?.then==`function`;function v(e=()=>{try{return window.localStorage}catch{return}},t){let n,r,i={getItem:(i,a)=>{let o=e=>{if(e||=``,n!==e){try{r=JSON.parse(e,t?.reviver)}catch{return a}n=e}return r},s=e()?.getItem(i)??null;return ne(s)?s.then(o):o(s)},setItem:(n,r)=>e()?.setItem(n,JSON.stringify(r,t?.replacer)),removeItem:t=>e()?.removeItem(t)},a=e=>(t,n,r)=>e(t,e=>{let t;try{t=JSON.parse(e||``)}catch{t=r}n(t)}),o;try{o=e()?.subscribe}catch{}return!o&&typeof window<`u`&&typeof window.addEventListener==`function`&&window.Storage&&(o=(t,n)=>{if(!(e()instanceof window.Storage))return()=>{};let r=r=>{r.storageArea===e()&&r.key===t&&n(r.newValue)};return window.addEventListener(`storage`,r),()=>{window.removeEventListener(`storage`,r)}}),o&&(i.subscribe=a(o)),i}v();var y=e=>Symbol.iterator in e,b=e=>`entries`in e,x=(e,t)=>{let n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(let[e,t]of n)if(!r.has(e)||!Object.is(t,r.get(e)))return!1;return!0},S=(e,t)=>{let n=e[Symbol.iterator](),r=t[Symbol.iterator](),i=n.next(),a=r.next();for(;!i.done&&!a.done;){if(!Object.is(i.value,a.value))return!1;i=n.next(),a=r.next()}return!!i.done&&!!a.done};function C(e,t){return Object.is(e,t)?!0:typeof e!=`object`||!e||typeof t!=`object`||!t||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:y(e)&&y(t)?b(e)&&b(t)?x(e,t):S(e,t):x({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}var w=e(t(),1);const T=e=>s(_(d,(0,w.useCallback)(t=>e(t),[]),C)),E=()=>T(D);function D(e){return e.w<1024&&e.w!==0}function O(e,t,n){let r=n.initialDeps??[],i;function a(){var a;let o;n.key&&n.debug?.call(n)&&(o=Date.now());let s=e();if(!(s.length!==r.length||s.some((e,t)=>r[t]!==e)))return i;r=s;let c;if(n.key&&n.debug?.call(n)&&(c=Date.now()),i=t(...s),n.key&&n.debug?.call(n)){let e=Math.round((Date.now()-o)*100)/100,t=Math.round((Date.now()-c)*100)/100,r=t/16,i=(e,t)=>{for(e=String(e);e.length<t;)e=` `+e;return e};console.info(`%câ± ${i(t,5)} /${i(e,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*r,120))}deg 100% 31%);`,n?.key)}return(a=n?.onChange)==null||a.call(n,i),i}return a.updateDeps=e=>{r=e},a}function k(e,t){if(e===void 0)throw Error(`Unexpected undefined${t?`: ${t}`:``}`);return e}var re=(e,t)=>Math.abs(e-t)<1.01,ie=(e,t,n)=>{let r;return function(...i){e.clearTimeout(r),r=e.setTimeout(()=>t.apply(this,i),n)}},A=e=>{let{offsetWidth:t,offsetHeight:n}=e;return{width:t,height:n}},ae=e=>e,oe=e=>{let t=Math.max(e.startIndex-e.overscan,0),n=Math.min(e.endIndex+e.overscan,e.count-1),r=[];for(let e=t;e<=n;e++)r.push(e);return r},j=(e,t)=>{let n=e.scrollElement;if(!n)return;let r=e.targetWindow;if(!r)return;let i=e=>{let{width:n,height:r}=e;t({width:Math.round(n),height:Math.round(r)})};if(i(A(n)),!r.ResizeObserver)return()=>{};let a=new r.ResizeObserver(t=>{let r=()=>{let e=t[0];if(e?.borderBoxSize){let t=e.borderBoxSize[0];if(t){i({width:t.inlineSize,height:t.blockSize});return}}i(A(n))};e.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(r):r()});return a.observe(n,{box:`border-box`}),()=>{a.unobserve(n)}},M={passive:!0},N=typeof window>`u`?!0:`onscrollend`in window,P=(e,t)=>{let n=e.scrollElement;if(!n)return;let r=e.targetWindow;if(!r)return;let i=0,a=e.options.useScrollendEvent&&N?()=>void 0:ie(r,()=>{t(i,!1)},e.options.isScrollingResetDelay),o=r=>()=>{let{horizontal:o,isRtl:s}=e.options;i=o?n.scrollLeft*(s&&-1||1):n.scrollTop,a(),t(i,r)},s=o(!0),c=o(!1);c(),n.addEventListener(`scroll`,s,M);let l=e.options.useScrollendEvent&&N;return l&&n.addEventListener(`scrollend`,c,M),()=>{n.removeEventListener(`scroll`,s),l&&n.removeEventListener(`scrollend`,c)}},F=(e,t,n)=>{if(t?.borderBoxSize){let e=t.borderBoxSize[0];if(e)return Math.round(e[n.options.horizontal?`inlineSize`:`blockSize`])}return e[n.options.horizontal?`offsetWidth`:`offsetHeight`]},I=(e,{adjustments:t=0,behavior:n},r)=>{var i,a;let o=e+t;(a=(i=r.scrollElement)?.scrollTo)==null||a.call(i,{[r.options.horizontal?`left`:`top`]:o,behavior:n})},L=class{constructor(e){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null,t=()=>e||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:e=new this.targetWindow.ResizeObserver(e=>{e.forEach(e=>{let t=()=>{this._measureElement(e.target,e)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()})}));return{disconnect:()=>{var n;(n=t())==null||n.disconnect(),e=null},observe:e=>t()?.observe(e,{box:`border-box`}),unobserve:e=>t()?.unobserve(e)}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([t,n])=>{n===void 0&&delete e[t]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:ae,rangeExtractor:oe,onChange:()=>{},measureElement:F,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:`data-index`,initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var t,n;(n=(t=this.options).onChange)==null||n.call(t,this,e)},this.maybeNotify=O(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{let e=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==e){if(this.cleanup(),!e){this.maybeNotify();return}this.scrollElement=e,this.scrollElement&&`ownerDocument`in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=this.scrollElement?.window??null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,t)=>{this.scrollAdjustments=0,this.scrollDirection=t?this.getScrollOffset()<e?`forward`:`backward`:null,this.scrollOffset=e,this.isScrolling=t,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?`width`:`height`]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset==`function`?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(e,t)=>{let n=new Map,r=new Map;for(let i=t-1;i>=0;i--){let t=e[i];if(n.has(t.lane))continue;let a=r.get(t.lane);if(a==null||t.end>a.end?r.set(t.lane,t):t.end<a.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return r.size===this.options.lanes?Array.from(r.values()).sort((e,t)=>e.end===t.end?e.index-t.index:e.end-t.end)[0]:void 0},this.getMeasurementOptions=O(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(e,t,n,r,i)=>(this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:t,scrollMargin:n,getItemKey:r,enabled:i}),{key:!1}),this.getMeasurements=O(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:t,scrollMargin:n,getItemKey:r,enabled:i},a)=>{if(!i)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(e=>{this.itemSizeCache.set(e.key,e.size)}));let o=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];let s=this.measurementsCache.slice(0,o);for(let i=o;i<e;i++){let e=r(i),o=this.options.lanes===1?s[i-1]:this.getFurthestMeasurement(s,i),c=o?o.end+this.options.gap:t+n,l=a.get(e),u=typeof l==`number`?l:this.options.estimateSize(i),d=c+u,f=o?o.lane:i%this.options.lanes;s[i]={index:i,start:c,size:u,end:d,key:e,lane:f}}return this.measurementsCache=s,s},{key:!1,debug:()=>this.options.debug}),this.calculateRange=O(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,t,n,r)=>this.range=e.length>0&&t>0?z({measurements:e,outerSize:t,scrollOffset:n,lanes:r}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=O(()=>{let e=null,t=null,n=this.calculateRange();return n&&(e=n.startIndex,t=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,t]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,t]},(e,t,n,r,i)=>r===null||i===null?[]:e({startIndex:r,endIndex:i,overscan:t,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{let t=this.options.indexAttribute,n=e.getAttribute(t);return n?parseInt(n,10):(console.warn(`Missing attribute name '${t}={index}' on measured element.`),-1)},this._measureElement=(e,t)=>{let n=this.indexFromElement(e),r=this.measurementsCache[n];if(!r)return;let i=r.key,a=this.elementsCache.get(i);a!==e&&(a&&this.observer.unobserve(a),this.observer.observe(e),this.elementsCache.set(i,e)),e.isConnected&&this.resizeItem(n,this.options.measureElement(e,t,this))},this.resizeItem=(e,t)=>{let n=this.measurementsCache[e];if(!n)return;let r=t-(this.itemSizeCache.get(n.key)??n.size);r!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange===void 0?n.start<this.getScrollOffset()+this.scrollAdjustments:this.shouldAdjustScrollPositionOnItemSizeChange(n,r,this))&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=r,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,t)),this.notify(!1))},this.measureElement=e=>{if(!e){this.elementsCache.forEach((e,t)=>{e.isConnected||(this.observer.unobserve(e),this.elementsCache.delete(t))});return}this._measureElement(e,void 0)},this.getVirtualItems=O(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,t)=>{let n=[];for(let r=0,i=e.length;r<i;r++){let i=t[e[r]];n.push(i)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{let t=this.getMeasurements();if(t.length!==0)return k(t[R(0,t.length-1,e=>k(t[e]).start,e)])},this.getOffsetForAlignment=(e,t,n=0)=>{let r=this.getSize(),i=this.getScrollOffset();t===`auto`&&(t=e>=i+r?`end`:`start`),t===`center`?e+=(n-r)/2:t===`end`&&(e-=r);let a=this.getTotalSize()+this.options.scrollMargin-r;return Math.max(Math.min(a,e),0)},this.getOffsetForIndex=(e,t=`auto`)=>{e=Math.max(0,Math.min(e,this.options.count-1));let n=this.measurementsCache[e];if(!n)return;let r=this.getSize(),i=this.getScrollOffset();if(t===`auto`)if(n.end>=i+r-this.options.scrollPaddingEnd)t=`end`;else if(n.start<=i+this.options.scrollPaddingStart)t=`start`;else return[i,t];let a=t===`end`?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,t,n.size),t]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(e,{align:t=`start`,behavior:n}={})=>{n===`smooth`&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(e,t),{adjustments:void 0,behavior:n})},this.scrollToIndex=(e,{align:t=`auto`,behavior:n}={})=>{n===`smooth`&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),e=Math.max(0,Math.min(e,this.options.count-1));let r=0,i=t=>{if(!this.targetWindow)return;let r=this.getOffsetForIndex(e,t);if(!r){console.warn(`Failed to get offset for index:`,e);return}let[i,o]=r;this._scrollToOffset(i,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{let t=this.getScrollOffset(),n=this.getOffsetForIndex(e,o);if(!n){console.warn(`Failed to get offset for index:`,e);return}re(n[0],t)||a(o)})},a=t=>{this.targetWindow&&(r++,r<10?this.targetWindow.requestAnimationFrame(()=>i(t)):console.warn(`Failed to scroll to index ${e} after 10 attempts.`))};i(t)},this.scrollBy=(e,{behavior:t}={})=>{t===`smooth`&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:t})},this.getTotalSize=()=>{let e=this.getMeasurements(),t;if(e.length===0)t=this.options.paddingStart;else if(this.options.lanes===1)t=e[e.length-1]?.end??0;else{let n=Array(this.options.lanes).fill(null),r=e.length-1;for(;r>=0&&n.some(e=>e===null);){let t=e[r];n[t.lane]===null&&(n[t.lane]=t.end),r--}t=Math.max(...n.filter(e=>e!==null))}return Math.max(t-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:t,behavior:n})=>{this.options.scrollToFn(e,{behavior:n,adjustments:t},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(e)}},R=(e,t,n,r)=>{for(;e<=t;){let i=(e+t)/2|0,a=n(i);if(a<r)e=i+1;else if(a>r)t=i-1;else return i}return e>0?e-1:0};function z({measurements:e,outerSize:t,scrollOffset:n,lanes:r}){let i=e.length-1,a=t=>e[t].start;if(e.length<=r)return{startIndex:0,endIndex:i};let o=R(0,i,a,n),s=o;if(r===1)for(;s<i&&e[s].end<n+t;)s++;else if(r>1){let a=Array(r).fill(0);for(;s<i&&a.some(e=>e<n+t);){let t=e[s];a[t.lane]=t.end,s++}let c=Array(r).fill(n+t);for(;o>=0&&c.some(e=>e>=n);){let t=e[o];c[t.lane]=t.start,o--}o=Math.max(0,o-o%r),s=Math.min(i,s+(r-1-s%r))}return{startIndex:o,endIndex:s}}var B=n(),V=typeof document<`u`?w.useLayoutEffect:w.useEffect;function H(e){let t=w.useReducer(()=>({}),{})[1],n={...e,onChange:(n,r)=>{var i;r?(0,B.flushSync)(t):t(),(i=e.onChange)==null||i.call(e,n,r)}},[r]=w.useState(()=>new L(n));return r.setOptions(n),V(()=>r._didMount(),[]),V(()=>r._willUpdate()),r}function U(e){return H({observeElementRect:j,observeElementOffset:P,scrollToFn:I,...e})}const W=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),G=(()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||`ontouchstart`in window)();var K=class{maxConcurrent;queue=[];activeCount=0;constructor(e={}){let{maxConcurrent:t=2}=e;this.maxConcurrent=Math.max(1,t)}enqueue(e){return new Promise((t,n)=>{let r={execute:e,resolve:t,reject:n};this.queue.push(r),this.drainQueue()})}getActiveCount(){return this.activeCount}getPendingCount(){return this.queue.length}getMaxConcurrent(){return this.maxConcurrent}setMaxConcurrent(e){if(!Number.isFinite(e))throw TypeError(`maxConcurrent must be a finite number`);let t=Math.max(1,Math.floor(e));t!==this.maxConcurrent&&(this.maxConcurrent=t,this.drainQueue())}drainQueue(){if(this.activeCount>=this.maxConcurrent)return;let e=this.queue.shift();e&&(this.activeCount+=1,(async()=>{try{let t=await e.execute();e.resolve(t)}catch(t){e.reject(t)}finally{this.activeCount=Math.max(0,this.activeCount-1),this.drainQueue()}})())}},q=class{maxSize;cache;cleanupFn;constructor(e=10,t){this.maxSize=e,this.cache=new Map,this.cleanupFn=t}get(e){let t=this.cache.get(e);if(t!==void 0)return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e)){let t=this.cache.get(e);this._cleanup(t,e,`Replacing existing cache entry for ${String(e)}`),this.cache.delete(e)}else if(this.cache.size>=this.maxSize){let e=this.cache.keys().next().value;if(e!==void 0){let t=this.cache.get(e);this._cleanup(t,e,`LRU eviction: ${String(e)}`),this.cache.delete(e)}}this.cache.set(e,t),console.info(`LRU Cache: Added ${String(e)}, cache size: ${this.cache.size}/${this.maxSize}`)}delete(e){let t=this.cache.get(e);return t===void 0?!1:(this._cleanup(t,e,`Manual deletion: ${String(e)}`),this.cache.delete(e))}has(e){return this.cache.has(e)}clear(){let e=0;for(let[t,n]of this.cache.entries())this._cleanup(n,t,`Cache clear: ${String(t)}`),e++;this.cache.clear(),console.info(`LRU Cache: Cleared ${e} cached items`)}size(){return this.cache.size}getStats(){return{size:this.cache.size,maxSize:this.maxSize,keys:Array.from(this.cache.keys())}}values(){return this.cache.values()}entries(){return this.cache.entries()}_cleanup(e,t,n){if(this.cleanupFn)try{this.cleanupFn(e,t,n)}catch(e){console.warn(`LRU Cache cleanup failed (${n}):`,e)}}},se=class{getName(){return`HEIC`}getSupportedFormats(){return[`image/heic`,`image/heif`]}async shouldConvert(e){try{return!ue()}catch(e){return console.error(`HEIC browser support detection failed:`,e),!1}}async convert(e,t,n){let{onLoadingStateUpdate:r}=n||{};try{let n=c.get(f);r?.({isConverting:!0,isQueueWaiting:!1,conversionMessage:n.t(`loading.heic.converting`),isHeicFormat:!0,loadingProgress:100,loadedBytes:e.size,totalBytes:e.size});let i=await de(e,t);return{url:i.url,convertedSize:i.convertedSize,format:i.format,originalSize:i.originalSize}}catch(e){throw console.error(`HEIC conversion failed:`,e),Error(`HEIC conversion failed: ${e}`)}}},J=new q(10,(e,t,n)=>{try{URL.revokeObjectURL(e.url),console.info(`HEIC cache: Revoked blob URL - ${n}`)}catch(e){console.warn(`Failed to revoke HEIC blob URL (${n}):`,e)}});function ce(e,t){return`${e}-${t.quality||1}-${t.format||`image/jpeg`}`}async function le(e){try{return await m(e)}catch(e){return console.warn(`Failed to detect HEIC format:`,e),!1}}const ue=()=>{let e=navigator.userAgent.match(/version\/(\d+)/i)?.[1];return W&&(e?Number.parseInt(e,10):0)>=17};async function de(e,t,n={}){let{quality:r=1,format:i=`image/jpeg`}=n,a=ce(t,n),o=J.get(a);if(o)return console.info(`Using cached HEIC conversion result`,o),o;try{if(!await le(e))throw Error(`File is not in HEIC/HEIF format`);let t=await h({blob:e,type:i,quality:r}),n={url:URL.createObjectURL(t),originalSize:e.size,convertedSize:t.size,format:i};return J.set(a,n),console.info(`HEIC conversion completed and cached: ${(e.size/1024).toFixed(1)}KB â†’ ${(t.size/1024).toFixed(1)}KB`),n}catch(e){throw console.error(`HEIC conversion failed:`,e),Error(`Failed to convert HEIC image: ${e instanceof Error?e.message:`Unknown error`}`)}}var fe=class{getName(){return`TIFF`}getSupportedFormats(){return[`image/tiff`,`image/tif`]}async shouldConvert(e){return!this.isBrowserSupportTiff()}async convert(e,t,n){let{onLoadingStateUpdate:r}=n||{};try{r?.({isConverting:!0,isQueueWaiting:!1,conversionMessage:`Converting TIFF image...`});let t=await this.convertTiffToJpeg(e);return{url:t.url,convertedSize:t.size,format:`image/jpeg`,originalSize:e.size}}catch(e){throw console.error(`TIFF conversion failed:`,e),Error(`TIFF conversion failed: ${e}`)}}isBrowserSupportTiff(){return!!W}async convertTiffToJpeg(e){try{let t=await o(()=>import(`./lib-DwfjP82C.js`),__vite__mapDeps([0,1])),n=await e.arrayBuffer(),r=t.decode(n);if(!r||r.length===0)throw Error(`Failed to decode TIFF image`);let i=r[0],{width:a,height:s,data:c,bitsPerSample:l}=i,u=document.createElement(`canvas`),d=u.getContext(`2d`);if(!d)throw Error(`Failed to get canvas context`);u.width=a,u.height=s;let f=d.createImageData(a,s),p=f.data;return this.processPixelData(c,p,l,i.alpha),d.putImageData(f,0,0),new Promise((e,t)=>{u.toBlob(n=>{n?e({url:URL.createObjectURL(n),size:n.size}):t(Error(`Failed to convert TIFF to JPEG`))},`image/jpeg`,1)})}catch(e){throw console.error(`TIFF to JPEG conversion failed:`,e),e}}processPixelData(e,t,n,r=!1){let i=r?4:3,a=t.length/4;for(let o=0;o<a;o++){let a=o*i,s=o*4;switch(n){case 8:{let n=e;t[s]=n[a]||0,t[s+1]=i>1?n[a+1]||0:n[a]||0,t[s+2]=i>2?n[a+2]||0:n[a]||0,t[s+3]=r&&n[a+3]||255;break}case 16:{let n=e;t[s]=Math.round((n[a]||0)/257),t[s+1]=i>1?Math.round((n[a+1]||0)/257):Math.round((n[a]||0)/257),t[s+2]=i>2?Math.round((n[a+2]||0)/257):Math.round((n[a]||0)/257),t[s+3]=r?Math.round((n[a+3]||65535)/257):255;break}case 32:{let n=e;t[s]=Math.round((n[a]||0)*255),t[s+1]=i>1?Math.round((n[a+1]||0)*255):Math.round((n[a]||0)*255),t[s+2]=i>2?Math.round((n[a+2]||0)*255):Math.round((n[a]||0)*255),t[s+3]=r?Math.round((n[a+3]||1)*255):255;break}}}}};const pe=new class{strategies=new Map;conversionPipeline;pendingConversions=new Map;constructor(e={}){this.conversionPipeline=new K({maxConcurrent:e.maxConcurrent??2}),this.registerStrategy(new se),this.registerStrategy(new fe)}registerStrategy(e){e.getSupportedFormats().forEach(t=>{this.strategies.set(t,e)}),console.info(`Registered image converter strategy: ${e.getName()}`)}removeStrategy(e){let t=!1,n=Array.from(this.strategies.values()).find(t=>t.getName()===e);return n&&(n.getSupportedFormats().forEach(e=>{this.strategies.get(e)===n&&(this.strategies.delete(e),t=!0)}),t&&console.info(`Removed image converter strategy: ${e}`)),t}getStrategies(){let e=new Set(this.strategies.values());return Array.from(e)}async findSuitableStrategy(e){try{let{fileTypeFromBlob:t}=await o(async()=>{let{fileTypeFromBlob:e}=await import(`./core-BdPZXYRH.js`);return{fileTypeFromBlob:e}},__vite__mapDeps([2,3,1])),n=await t(e);if(!n)return console.info(`Could not detect file type with file-type library`),null;console.info(`Detected file type: ${n.ext} (${n.mime})`);let r=this.strategies.get(n.mime);return r?await r.shouldConvert(e)?(console.info(`Found suitable conversion strategy: ${r.getName()}`),r):(console.info(`Strategy ${r.getName()} detected but conversion not needed`),null):(console.info(`No strategy found for MIME type: ${n.mime}`),null)}catch(e){return console.error(`File type detection failed:`,e),null}}async convertImage(e,t,n){let r=await this.findSuitableStrategy(e);if(!r)return console.info(`No conversion strategy needed for this image`),null;console.info(`Converting image using ${r.getName()} strategy`);let i=this.getConversionTaskKey(r,t),a=n?.onLoadingStateUpdate,o=this.conversionPipeline.getActiveCount()>=this.conversionPipeline.getMaxConcurrent(),s=this.pendingConversions.get(i);if(s)return console.info(`Joining pending conversion task for ${r.getName()} (${t})`),await s;a&&o&&a({isConverting:!0,isQueueWaiting:!0,conversionMessage:c.get(f).t(`loading.queue.waiting`)});let l=this.conversionPipeline.enqueue(async()=>{try{return a?.({isQueueWaiting:!1,conversionMessage:void 0}),await r.convert(e,t,n)}finally{this.pendingConversions.delete(i)}});return this.pendingConversions.set(i,l),await l}getSupportedFormats(){return Array.from(this.strategies.keys())}getPipelineStats(){return{active:this.conversionPipeline.getActiveCount(),pending:this.conversionPipeline.getPendingCount()}}setMaxConcurrentConversions(e){this.conversionPipeline.setMaxConcurrent(e)}getConversionTaskKey(e,t){return`${e.getName()}::${t}`}};async function me(e,t){try{let{motionPhotoOffset:n,motionPhotoVideoSize:r}=t;if(r&&r>0)try{let t=await he(e,n,r);if(t)return URL.createObjectURL(t)}catch(e){console.warn(`[motion-photo] Range request failed, falling back to full fetch:`,e)}let i=await ge(e,n,r);return i?URL.createObjectURL(i):null}catch(e){return console.error(`[motion-photo] Failed to extract video:`,e),null}}async function he(e,t,n){let r=t+n-1,i=await fetch(e,{headers:{Range:`bytes=${t}-${r}`}});if(i.status!==206)throw Error(`Range request not supported`);let a=await i.blob();if(!await Y(a))throw Error(`Invalid MP4 data`);return new Blob([a],{type:`video/mp4`})}async function ge(e,t,n){let r=await(await fetch(e)).arrayBuffer(),i=n?r.slice(t,t+n):r.slice(t),a=new Blob([i],{type:`video/mp4`});return await Y(a)?a:(console.error(`[motion-photo] Extracted data is not a valid MP4`),null)}async function Y(e){if(e.size<32)return!1;let t=await e.slice(0,32).arrayBuffer(),n=new Uint8Array(t),r=[102,116,121,112];for(let e=0;e<=n.length-4;e++)if(n[e]===r[0]&&n[e+1]===r[1]&&n[e+2]===r[2]&&n[e+3]===r[3])return!0;return!1}async function _e(e,t={}){try{return await ve(e,t)}catch(e){return console.error(`Transmux error:`,e),{success:!1,error:e instanceof Error?e.message:`Unknown transmux error`}}}async function ve(e,t={}){let{onProgress:n}=t;try{console.info(`ðŸŽ¯ Starting simple transmux conversion`);let{t}=u();n?.({isConverting:!0,progress:10,message:t(`video.conversion.transmux.fetching`)});let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch video: ${r.statusText}`);let i=await r.arrayBuffer();n?.({isConverting:!0,progress:30,message:t(`video.conversion.transmux.analyzing`)}),n?.({isConverting:!0,progress:60,message:t(`video.conversion.transmux.converting`)});let a=new Uint8Array(i);n?.({isConverting:!0,progress:80,message:t(`video.conversion.transmux.creating`)});let o=new Blob([a],{type:`video/mp4`}),s=URL.createObjectURL(o);return n?.({isConverting:!1,progress:100,message:t(`video.conversion.transmux.success`)}),{success:!0,videoUrl:s,convertedSize:o.size}}catch(e){return console.error(`Simple transmux error:`,e),{success:!1,error:e instanceof Error?e.message:`Simple transmux failed`}}}var X=new q(10,(e,t,n)=>{if(e.videoUrl)try{URL.revokeObjectURL(e.videoUrl),console.info(`Video cache: Revoked blob URL - ${n}`)}catch(e){console.warn(`Failed to revoke video blob URL (${n}):`,e)}});function ye(e,t){return new Promise(n=>{_e(e,{onProgress:t}).then(e=>{n(e)}).catch(e=>{console.error(`Transmux conversion failed:`,e),n({success:!1,error:e instanceof Error?e.message:`Transmux failed`})})})}function be(){let e=document.createElement(`video`).canPlayType(`video/quicktime`);return W?!0:e===`probably`||e===`maybe`}function xe(e){let t=e.toLowerCase();return t.includes(`.mov`)||t.endsWith(`.mov`)?be()?(console.info(`Browser natively supports MOV format, skipping conversion`),!1):(console.info(`Browser does not support MOV format, conversion needed`),!0):!1}async function Se(e,t,n=!1){let{t:r}=u();if(n)console.info(`Force reconversion: clearing cached result for`,e),X.delete(e);else{let n=X.get(e);if(n)return console.info(`Using cached video conversion result`),t?.({isConverting:!1,progress:100,message:r(`video.conversion.cached.result`)}),console.info(`Cached video conversion result:`,n),n}try{console.info(`ðŸŽ¯ Target format: MP4 (H.264)`),t?.({isConverting:!0,progress:0,message:r(`video.conversion.transmux.high.quality`)});let n=await ye(e,t);return X.set(e,n),n.success?console.info(`conversion completed successfully and cached`):console.error(`conversion failed:`,n.error),n}catch(e){return console.error(`conversion failed:`,e),{success:!1,error:`Conversion Failed: ${e instanceof Error?e.message:e}`}}}var Z=new q(10,(e,t,n)=>{try{URL.revokeObjectURL(e.blobSrc),console.info(`Regular image cache: Revoked blob URL - ${n}`)}catch(e){console.warn(`Failed to revoke regular image blob URL (${n}):`,e)}});function Ce(e){return e}var we=class{currentXHR=null;delayTimer=null;async isValidImageBlob(e){if(e.size===0)return console.warn(`Empty blob detected`),!1;try{let t=await p(e);return t?t.mime.startsWith(`image/`)?(console.info(`Valid image detected: ${t.ext} (${t.mime})`),!0):(console.warn(`Invalid file type detected: ${t.ext} (${t.mime})`),!1):(console.warn(`Could not detect file type from blob`),!1)}catch(e){return console.error(`Failed to detect file type:`,e),!1}}async loadImage(e,t={}){let{onProgress:n,onError:r,onLoadingStateUpdate:i}=t;return i?.({isVisible:!0}),new Promise((a,o)=>{this.delayTimer=setTimeout(async()=>{let s=new XMLHttpRequest;s.open(`GET`,e),s.responseType=`blob`,s.onload=async()=>{if(s.status===200)try{let n=s.response;if(!await this.isValidImageBlob(n)){i?.({isVisible:!1}),r?.(),o(Error(`Response is not a valid image`));return}a(await this.processImageBlob(n,e,t))}catch(e){i?.({isVisible:!1}),r?.(),o(e)}else i?.({isVisible:!1}),r?.(),o(Error(`HTTP ${s.status}`))},s.onprogress=e=>{if(e.lengthComputable){let t=e.loaded/e.total*100;i?.({loadingProgress:t,loadedBytes:e.loaded,totalBytes:e.total}),n?.(t)}},s.onerror=()=>{i?.({isVisible:!1}),r?.(),o(Error(`Network error`))},s.send(),this.currentXHR=s},300)})}async processVideo(e,t,n={}){let{onLoadingStateUpdate:r}=n;return new Promise((i,a)=>{(async()=>{let o=c.get(f);try{if(e.type===`motion-photo`){console.info(`Processing Motion Photo embedded video...`),r?.({isVisible:!0,conversionMessage:o.t(`video.motion-photo.extracting`)});let n=await me(e.imageUrl,{motionPhotoOffset:e.offset,motionPhotoVideoSize:e.size,presentationTimestampUs:e.presentationTimestamp});if(n)t.src=n,t.load(),console.info(`Motion Photo video extracted successfully`),r?.({isVisible:!1}),i(await new Promise(e=>{let r=()=>{t.removeEventListener(`canplaythrough`,r),e({convertedVideoUrl:n,conversionMethod:`motion-photo-extraction`})};t.addEventListener(`canplaythrough`,r)}));else throw Error(`Failed to extract Motion Photo video`)}else if(e.type===`live-photo`)xe(e.videoUrl)?i(await this.convertVideo(e.videoUrl,t,n)):i(await this.loadDirectVideo(e.videoUrl,t));else throw Error(`No video source provided`)}catch(e){console.error(`Failed to process video:`,e),r?.({isVisible:!1}),a(e)}})()})}async processImageBlob(e,t,n){let{onError:r,onLoadingStateUpdate:i}=n;try{let r=await pe.convertImage(e,t,n);return r?(console.info(`Image converted: ${(e.size/1024).toFixed(1)}KB â†’ ${(r.convertedSize/1024).toFixed(1)}KB`),i?.({isVisible:!1}),{blobSrc:r.url,convertedUrl:r.url}):this.processRegularImage(e,t,n)}catch(a){console.error(`Image conversion failed:`,a);try{return console.info(`Falling back to regular image processing`),this.processRegularImage(e,t,n)}catch(e){throw console.error(`Fallback to regular image processing also failed:`,e),i?.({isVisible:!1}),r?.(),a}}}processRegularImage(e,t,n){let{onLoadingStateUpdate:r}=n,i=Ce(t),a=Z.get(i);if(a)return console.info(`Using cached regular image result`,a),r?.({isVisible:!1}),{blobSrc:a.blobSrc};let o=URL.createObjectURL(e),s={blobSrc:o,originalSize:e.size,format:e.type};return Z.set(i,s),console.info(`Regular image processed and cached: ${(e.size/1024).toFixed(1)}KB, URL: ${t}`),r?.({isVisible:!1}),{blobSrc:o}}async convertVideo(e,t,n){let{onLoadingStateUpdate:r}=n;r?.({isVisible:!0,isConverting:!0,loadingProgress:0}),console.info(`Converting MOV video to MP4...`);let i=c.get(f),a=await Se(e,e=>{let t=[i.t(`video.codec.keyword`),`encoder`,`codec`,`ç¼–ç å™¨`].some(t=>e.message.toLowerCase().includes(t.toLowerCase()));r?.({isVisible:!0,isConverting:e.isConverting,loadingProgress:e.progress,conversionMessage:e.message,codecInfo:t?e.message:void 0})});if(a.success&&a.videoUrl){let e=a.videoUrl;return t.src=a.videoUrl,t.load(),console.info(`Video conversion completed. Size: ${a.convertedSize?Math.round(a.convertedSize/1024):`unknown`}KB`),r?.({isVisible:!1}),new Promise(n=>{let r=()=>{t.removeEventListener(`canplaythrough`,r),n({convertedVideoUrl:e})};t.addEventListener(`canplaythrough`,r)})}else throw console.error(`Video conversion failed:`,a.error),r?.({isVisible:!1}),Error(a.error||`Video conversion failed`)}async loadDirectVideo(e,t){return t.src=e,t.load(),new Promise(e=>{let n=()=>{t.removeEventListener(`canplaythrough`,n),e({conversionMethod:``})};t.addEventListener(`canplaythrough`,n)})}cleanup(){this.delayTimer&&=(clearTimeout(this.delayTimer),null),this.currentXHR&&=(this.currentXHR.abort(),null)}},Q=r(),$=e(i(),1);const Te=e=>{let t=(0,Q.c)(14),{image:n,name:r,fallback:i,size:a,className:o}=e,s=i===void 0?`?`:i,c=a===void 0?36:a,u=r||s,d;t[0]===u?d=t[1]:(d=u.slice(0,1).toUpperCase(),t[0]=u,t[1]=d);let f=d,p;t[2]===o?p=t[3]:(p=l(`flex shrink-0 items-center justify-center rounded-full bg-white/10 text-sm font-semibold text-white/80`,o),t[2]=o,t[3]=p);let m;t[4]===c?m=t[5]:(m={width:c,height:c},t[4]=c,t[5]=m);let h;t[6]!==u||t[7]!==n||t[8]!==f?(h=n?(0,$.jsx)(`img`,{src:n,alt:u,className:`h-full w-full rounded-full object-cover`}):(0,$.jsx)(`span`,{children:f}),t[6]=u,t[7]=n,t[8]=f,t[9]=h):h=t[9];let g;return t[10]!==p||t[11]!==m||t[12]!==h?(g=(0,$.jsx)(`div`,{className:p,style:m,children:h}),t[10]=p,t[11]=m,t[12]=h,t[13]=g):g=t[13],g};export{E as a,U as i,we as n,_ as o,G as r,Te as t};